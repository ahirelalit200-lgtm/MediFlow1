<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Medicines</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/chatbot.css" />
  <script src="js/config.js"></script>
  <style>
    .medicine-container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    h2,
    h3 {
      text-align: center;
      color: #1976d2;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }

    th,
    td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: center;
    }

    th {
      background-color: #f0f4f8;
    }

    input,
    select {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 100%;
    }

    button {
      background-color: #1976d2;
      color: #fff;
      border: none;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background-color: #125cb1;
    }

    .remove-btn {
      background-color: #ff5252;
    }

    .remove-btn:hover {
      background-color: #e03b3b;
    }

    #preview {
      margin-top: 30px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #f9f9f9;
    }

    #preview h3 {
      margin-bottom: 15px;
      color: #444;
    }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 20px;
      background: #ffffff;
      color: #fff;
    }

    .navbar .logo span {
      font-size: 20px;
      font-weight: bold;
    }

    .navbar ul {
      list-style: none;
      display: flex;
      gap: 20px;
    }

    .navbar ul li {
      cursor: pointer;
    }

    .theme-toggle-btn {
      background-color: #ffffff;
      border: 2px solid #e0e0e0;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      margin-right: 15px;
    }

    .theme-toggle-btn:hover {
      background-color: #29a9f8;
      border-color: #29a9f8;
      transform: scale(1.05);
    }

    .theme-icon {
      font-size: 1.2rem;
      transition: transform 0.3s ease;
    }
  </style>
</head>

<body>

  <header class="navbar">
    <div class="logo">
      <img src="assets/care.png" alt="Logo" height="40" />
      <span>Medi<strong>Flow</strong></span>
    </div>
    <nav>
      <ul>
        <li onclick="navigateTo('dashboard')">Home</li>
        <li onclick="navigateTo('history')">History</li>
        <li onclick="navigateTo('appointments')">Appointments</li>
        <li onclick="navigateTo('analytics')">Analytics</li>
        <li onclick="navigateTo('xray')">X-Ray</li>
        <li onclick="navigateTo('prescription')">Prescription</li>
      </ul>
    </nav>
    <div class="header-right" id="auth-buttons">
      <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span class="theme-icon" id="theme-icon">ðŸŒ™</span>
      </button>
    </div>
  </header>

  <div class="medicine-container">
    <h2>Manage Medicines</h2>

    <table id="medicine-table">
      <thead>
        <tr>
          <th>Code</th>
          <th>Medicine Name</th>
          <th>Dosage (e.g. 1-0-1)</th>
          <th>Duration (days)</th>
          <th>Measure</th>
          <th>Instruction</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody id="medicine-table-body">
        <tr>
          <td><input type="text" placeholder="Code" required></td>
          <td><input type="text" placeholder="Medicine name" required></td>
          <td><input type="text" placeholder="1-0-1" required></td>
          <td><input type="text" placeholder="3 days" required></td>
          <td><input type="number" placeholder="6" required></td>
          <td>
            <select required>
              <option value="à¤œà¥‡à¤µà¤£ à¤†à¤§à¥€">à¤œà¥‡à¤µà¤£ à¤†à¤§à¥€</option>
              <option value="à¤œà¥‡à¤µà¤£ à¤¨à¤‚à¤¤à¤°">à¤œà¥‡à¤µà¤£ à¤¨à¤‚à¤¤à¤°</option>
            </select>
          </td>
          <td><button type="button" class="remove-btn" onclick="removeRow(this)">X</button></td>
        </tr>
      </tbody>
    </table>

    <button onclick="addRow()">Add Medicine</button>
    <button onclick="saveMedicines()">Save Medicines</button>

    <div id="preview" style="display:none;">
      <h3>Preview Medicines</h3>
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Medicine Name</th>
            <th>Dosage</th>
            <th>Duration</th>
            <th>Measure</th>
            <th>Instruction</th>
          </tr>
        </thead>
        <tbody id="preview-body"></tbody>
      </table>
    </div>

    <!-- Saved Medicines Section -->
    <div id="saved-medicines-section" style="margin-top: 40px;">
      <h3>Saved Medicines</h3>
      <div id="no-medicines-message" style="text-align: center; padding: 20px; color: #666; display: none;">
        No medicines saved yet. Add medicines above and click "Save Medicines".
      </div>
      <table id="saved-medicines-table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f0f4f8;">
            <th style="padding: 10px; border: 1px solid #ddd;">Code</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Medicine Name</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Dosage</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Duration</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Measure</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Instruction</th>
            <th style="padding: 10px; border: 1px solid #ddd;">Actions</th>
          </tr>
        </thead>
        <tbody id="saved-medicines-body">
        </tbody>
      </table>
    </div>
  </div>

  <script>
    // Theme and Auth management
    function renderAuthButtons() {
      const div = document.getElementById("auth-buttons");
      if (!div) return;
      const displayName = (JSON.parse(localStorage.getItem("doctorProfile") || "null")?.fullName) || localStorage.getItem("doctorName");
      const email = localStorage.getItem("email");
      if (displayName || email) {
        div.innerHTML = ``; // Hide login buttons if already logged in
      } else {
        div.innerHTML = `<button class="book-btn" onclick="location.href='signup.html'">Login</button>`;
      }
    }

    function navigateTo(page) {
      const routes = {
        'dashboard': 'doctor-dashboard.html',
        'history': 'history.html',
        'appointments': 'doctor-appointments.html',
        'analytics': 'analytics.html',
        'xray': 'xray.html',
        'prescription': 'prescription.html',
        'medicine': 'medicine.html',
        'signup': 'signup.html',
        'profile': 'profile.html'
      };
      if (routes[page]) window.location.href = routes[page];
    }

    function logout() {
      try { localStorage.setItem("global_logout", String(Date.now())); } catch (e) { }
      localStorage.removeItem("email");
      localStorage.removeItem("token");
      localStorage.removeItem("loggedIn");
      localStorage.removeItem("doctorName");
      localStorage.removeItem("doctorProfile");
      renderAuthButtons();
      window.location.href = "index.html";
    }

    // Medicine Row Management
    function addRow() {
      const tableBody = document.getElementById("medicine-table-body");
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="text" placeholder="Code" required></td>
        <td><input type="text" placeholder="Medicine name" required></td>
        <td><input type="text" placeholder="1-0-1" required></td>
        <td><input type="text" placeholder="3 days" required></td>
        <td><input type="number" placeholder="6" required></td>
        <td>
          <select required>
            <option value="à¤œà¥‡à¤µà¤£ à¤†à¤§à¥€">à¤œà¥‡à¤µà¤£ à¤†à¤§à¥€</option>
            <option value="à¤œà¥‡à¤µà¤£ à¤¨à¤‚à¤¤à¤°" selected>à¤œà¥‡à¤µà¤£ à¤¨à¤‚à¤¤à¤°</option>
          </select>
        </td>
        <td><button type="button" class="remove-btn" onclick="removeRow(this)">X</button></td>
      `;
      tableBody.appendChild(row);
    }

    function removeRow(btn) {
      const rows = document.querySelectorAll("#medicine-table-body tr");
      if (rows.length > 1) {
        btn.closest("tr").remove();
      } else {
        alert("At least one row is required.");
      }
    }

    // Logic for saving medicines (allows multiple per code)
    async function saveMedicines() {
      const rows = document.querySelectorAll("#medicine-table-body tr");
      const medicinesToAdd = [];

      rows.forEach(row => {
        const inputs = row.querySelectorAll("input, select");
        const code = inputs[0].value.trim();
        const name = inputs[1].value.trim();
        const dosage = inputs[2].value.trim();
        const duration = inputs[3].value.trim();
        const measure = inputs[4].value.trim();
        const instruction = inputs[5].value.trim();

        if (code && name) { // Only add if code and name are present
          medicinesToAdd.push({
            code,
            name,
            dosage,
            duration,
            measure,
            instruction,
          });
        }
      });

      if (medicinesToAdd.length === 0) {
        alert("Please enter both Name and Code for at least one medicine.");
        return;
      }

      const token = localStorage.getItem("token");
      const savedMedicinesWithIds = [];

      // Save each to backend and get IDs
      for (const m of medicinesToAdd) {
        let savedMed = { ...m };
        if (token) {
          try {
            const payload = {
              name: m.name,
              dosageAmount: m.measure,
              morning: m.instruction.includes("à¤œà¥‡à¤µà¤£ à¤†à¤§à¥€") ? "before" : "none", // Simplified mapping
              afternoon: "none", // Not directly mapped from current instruction
              night: m.instruction.includes("à¤œà¥‡à¤µà¤£ à¤¨à¤‚à¤¤à¤°") ? "after" : "none", // Simplified mapping
              code: m.code
            };
            const res = await fetch(`${window.API_BASE_URL}/api/medicines`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`
              },
              body: JSON.stringify(payload)
            });
            if (res.ok) {
              const data = await res.json();
              if (data._id) savedMed._id = data._id;
            }
          } catch (err) {
            console.warn("Backend save failed for:", m.name, err);
          }
        }
        savedMedicinesWithIds.push(savedMed);
      }

      // Update Local Storage
      const storageKey = getStorageKey();
      let localMeds = [];
      try { localMeds = JSON.parse(localStorage.getItem(storageKey) || "[]"); } catch (e) { }

      const merged = [...localMeds];
      savedMedicinesWithIds.forEach(newMed => {
        // Prevent exact duplicates (same code + same name)
        const isDuplicate = merged.some(m => m.code === newMed.code && m.name === newMed.name);
        if (!isDuplicate) merged.push(newMed);
      });

      localStorage.setItem(storageKey, JSON.stringify(merged));
      alert(token ? `Saved ${savedMedicinesWithIds.length} medicines.` : "Medicines saved locally.");

      // Reset input rows
      document.getElementById("medicine-table-body").innerHTML = `
        <tr>
          <td><input type="text" placeholder="Code" required></td>
          <td><input type="text" placeholder="Medicine name" required></td>
          <td><input type="text" placeholder="1-0-1" required></td>
          <td><input type="text" placeholder="3 days" required></td>
          <td><input type="number" placeholder="6" required></td>
          <td>
            <select required>
              <option value="à¤œà¥‡à¤µà¤£ à¤†à¤§à¥€">à¤œà¥‡à¤µà¤£ à¤†à¤§à¥€</option>
              <option value="à¤œà¥‡à¤µà¤£ à¤¨à¤‚à¤¤à¤°" selected>à¤œà¥‡à¤µà¤£ à¤¨à¤‚à¤¤à¤°</option>
            </select>
          </td>
          <td><button type="button" class="remove-btn" onclick="removeRow(this)">X</button></td>
        </tr>
      `;

      displaySavedMedicines();
    }

    function displaySavedMedicines() {
      const storageKey = getStorageKey();
      let medicines = [];
      try { medicines = JSON.parse(localStorage.getItem(storageKey) || "[]"); } catch (e) { }

      const tableBody = document.getElementById("saved-medicines-body");
      const noMsg = document.getElementById("no-medicines-message");
      const table = document.getElementById("saved-medicines-table");

      if (!tableBody) return;
      tableBody.innerHTML = "";

      if (medicines.length === 0) {
        noMsg.style.display = "block";
        table.style.display = "none";
        return;
      }

      noMsg.style.display = "none";
      table.style.display = "table";

      medicines.forEach((med) => {
        const row = document.createElement("tr");
        const deleteId = med._id || `local_${med.code}_${med.name}`;

        row.innerHTML = `
          <td style="padding: 10px; border: 1px solid #ddd;">${med.code || "-"}</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${med.name || "-"}</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${med.dosage || "-"}</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${med.duration || "-"}</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${med.measure || "-"}</td>
          <td style="padding: 10px; border: 1px solid #ddd;">${med.instruction || "-"}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
            <button type="button" onclick="deleteMedicineById('${deleteId}')" class="remove-btn"
                    style="background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
              Delete
            </button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    async function deleteMedicineById(id) {
      if (!confirm("Delete this medicine?")) return;

      const token = localStorage.getItem("token");
      const isLocal = String(id).startsWith("local_");

      if (token && !isLocal) {
        try {
          await fetch(`${window.API_BASE_URL}/api/medicines/id/${id}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${token}` }
          });
        } catch (err) {
          console.error("Server delete failed:", err);
        }
      }

      // Update Local Storage
      const storageKey = getStorageKey();
      let medicines = [];
      try { medicines = JSON.parse(localStorage.getItem(storageKey) || "[]"); } catch (e) { }

      let filtered;
      if (isLocal) {
        const parts = id.split("_");
        const lCode = parts[1];
        const lName = parts.slice(2).join("_");
        filtered = medicines.filter(m => !(m.code === lCode && m.name === lName));
      } else {
        filtered = medicines.filter(m => m._id !== id);
      }

      localStorage.setItem(storageKey, JSON.stringify(filtered));
      displaySavedMedicines();
    }

    function getStorageKey() {
      const email = (localStorage.getItem("email") || "").toLowerCase().trim();
      return email ? `medicines_user_${email}` : "medicines";
    }

    async function initializePage() {
      renderAuthButtons();
      const token = localStorage.getItem("token");
      if (token) {
        try {
          const res = await fetch(`${window.API_BASE_URL}/api/medicines`, {
            headers: { Authorization: `Bearer ${token}` }
          });
          if (res.ok) {
            const list = await res.json();
            // Backend might return { medicines: [] } or just []
            const meds = Array.isArray(list) ? list : (list.medicines || []);
            localStorage.setItem(getStorageKey(), JSON.stringify(meds));
          }
        } catch (err) {
          console.warn("Sync failed:", err);
        }
      }
      displaySavedMedicines();
    }

    window.onload = initializePage;

    // Cross-tab logout listener
    window.addEventListener("storage", function (e) {
      if (e && e.key === "global_logout") {
        logout();
      }
    });
  </script>
</body>

</html>




<!--<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage Medicines</title>
  <link rel="stylesheet" href="css/styles.css" />
  <style>
    .medicine-container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 20px;
    }

    .medicine-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
    }

    .medicine-form, .medicine-list {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      flex: 1 1 450px;
    }

    .medicine-form h2,
    .medicine-list h3 {
      text-align: center;
      color: #1976d2;
      margin-bottom: 20px;
    }

    #medicine-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #medicine-form input,
    #medicine-form select {
      padding: 10px;
      font-size: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    #medicine-form label {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #medicine-form button {
      background-color: #1976d2;
      color: #fff;
      border: none;
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    #medicine-form button:hover {
      background-color: #125cb1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ddd;
    }

    th {
      background-color: #f0f4f8;
    }

    @media screen and (max-width: 768px) {
      .medicine-layout {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>

  <header class="navbar">
    <div class="logo">
      <img src="assets/care.png" alt="Logo" height="40" />
      <span>Smile<strong>Care</strong></span>
    </div>
    <nav>
      <ul>
        <li onclick="location.href='index.html'">Home</li>
        <li onclick="location.href='prescription.html'">Prescriptions</li>
        <li onclick="location.href='history.html'">History</li>
        <li onclick="location.href='profile.html'">Profile</li>
      </ul>
    </nav>
    <div class="header-right">
      <button class="book-btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <div class="medicine-container">
    <div class="medicine-layout">   -->

<!-- Form Section -->
<!--  <div class="medicine-form">
        <h2>Add New Medicine</h2>
        <form id="medicine-form">
          <input type="text" id="medicineName" placeholder="Medicine Name" required />
          <input type="number" id="dosageAmount" placeholder="Dosage (e.g., 500)" required />

          <select id="unit" required>
            <option value="">Select Unit</option>
            <option value="mg">mg</option>
            <option value="ml">ml</option>
            <option value="tablet">tablet</option>
            <option value="capsule">capsule</option>
            <option value="syrup">syrup</option>
          </select>  -->

<!--  Manual Medicine Code Only -->
<!--   <input type="text" id="medicineCode" placeholder="Medicine Code" required />

          <label>
            Morning:
            <select id="morningFood">
              <option value="none">None</option>
              <option value="before">Before Food</option>
              <option value="after">After Food</option>
            </select>
          </label>

          <label>
            Afternoon:
            <select id="afternoonFood">
              <option value="none">None</option>
              <option value="before">Before Food</option>
              <option value="after">After Food</option>
            </select>
          </label>

          <label>
            Night:
            <select id="nightFood">
              <option value="none">None</option>
              <option value="before">Before Food</option>
              <option value="after">After Food</option>
            </select>
          </label>

          <button type="submit">Add Medicine</button>
        </form>
      </div>  -->

<!-- Table Section -->
<!---  <div class="medicine-list">
        <h3>Medicine List</h3>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Dosage (Morning / Afternoon / Night)</th>
              <th>Code</th>
            </tr>
          </thead>
          <tbody id="medicine-table-body">
           
          </tbody>
        </table>
      </div>

    </div>
  </div>

  <script>
    function logout() {
      localStorage.clear();
      location.href = "signup.html";
    }

    // Medicine Form Handling
    const form = document.getElementById("medicine-form");
    const tableBody = document.getElementById("medicine-table-body");

    const loadMedicines = () => {
      tableBody.innerHTML = "";
      const medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
      medicines.forEach((med) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${med.name} (${med.dosageAmount} ${med.unit})</td>
          <td>${med.morning} / ${med.afternoon} / ${med.night}</td>
          <td>${med.code}</td>
        `;
        tableBody.appendChild(row);
      });
    };

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const name = document.getElementById("medicineName").value;
      const dosageAmount = document.getElementById("dosageAmount").value;
      const unit = document.getElementById("unit").value;
      const morning = document.getElementById("morningFood").value;
      const afternoon = document.getElementById("afternoonFood").value;
      const night = document.getElementById("nightFood").value;
      const code = document.getElementById("medicineCode").value.trim();

      const newMedicine = { name, dosageAmount, unit, morning, afternoon, night, code };

      const medicines = JSON.parse(localStorage.getItem("medicines") || "[]");
      medicines.push(newMedicine);
      localStorage.setItem("medicines", JSON.stringify(medicines));

      form.reset();
      loadMedicines();
    });

    window.onload = loadMedicines;
  </script>
  <script src="js/chatbot.js"></script>
</body>
</html>