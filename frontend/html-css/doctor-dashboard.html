<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Dashboard - MediFlow</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/chatbot.css" />
  <script src="js/config.js"></script>
</head>

<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">
      <img src="assets/care.png" alt="Logo" height="40" />
      <span>Medi<strong>Flow</strong></span>
    </div>
    <nav>
      <ul>
        <li onclick="navigateTo('dashboard')">Home</li>
        <li onclick="navigateTo('history')">History</li>
        <li onclick="navigateTo('appointments')">Appointments</li>
        <li onclick="navigateTo('analytics')">Analytics</li>
        <li onclick="navigateTo('xray')">X-Ray</li>
        <li onclick="navigateTo('medicine')">Add Medicine</li>
      </ul>
    </nav>
    <div class="header-right">
      <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span class="theme-icon" id="theme-icon">üåô</span>
      </button>
      <div id="auth-buttons">
        <!-- Will be filled by JS -->
      </div>
    </div>
  </header>

  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-text">
      <h1>Welcome back, <span class="highlight" id="doctor-name">Doctor</span></h1>
      <p>Your clinical workspace is ready. Manage prescriptions, analyze X-rays, and track your patient appointments
        with professional precision.</p>
      <button class="learn-btn" onclick="navigateTo('prescription')">New Prescription</button>
    </div>
  </section>

  <!-- Features Section -->
  <section class="features">
    <h2>Clinical Quick Actions</h2>
    <div class="feature-grid">
      <div class="feature-card" onclick="navigateTo('prescription')">
        <div class="feature-icon">üìù</div>
        <h3>Prescriptions</h3>
        <p>Generate professional digital prescriptions in seconds. Share and print instantly.</p>
      </div>
      <div class="feature-card" onclick="navigateTo('history')">
        <div class="feature-icon">üîç</div>
        <h3>Patient History</h3>
        <p>Access full record history with advanced search and detailed patient tracking.</p>
      </div>
      <div class="feature-card" onclick="navigateTo('appointments')">
        <div class="feature-icon">üìÖ</div>
        <h3>Appointments</h3>
        <p>Review and manage your daily schedule. Track upcoming patient visits and notes.</p>
      </div>
      <div class="feature-card" onclick="navigateTo('analytics')">
        <div class="feature-icon">üìä</div>
        <h3>Insights</h3>
        <p>View clinic performance analytics, patient trends, and medication statistics.</p>
      </div>
      <div class="feature-card" onclick="navigateTo('xray')">
        <div class="feature-icon">ü©ª</div>
        <h3>AI X-Ray</h3>
        <p>Upload scans for instant AI-assisted diagnostic reports and patient education.</p>
      </div>
      <div class="feature-card" onclick="navigateTo('medicine')">
        <div class="feature-icon">üíä</div>
        <h3>Pharmacy</h3>
        <p>Maintain your custom medicine inventory and frequently used dosages.</p>
      </div>
    </div>
  </section>

  <script>
    function navigateTo(page) {
      if (page === "signup") {
        window.location.href = "signup.html";
      } else if (page === "profile") {
        window.location.href = "profile.html";
      } else if (page === "prescription") {
        window.location.href = "prescription.html";
      } else if (page === "history") {
        window.location.href = "history.html";
      } else if (page === "analytics") {
        window.location.href = "analytics.html";
      } else if (page === "xray") {
        window.location.href = "xray.html";
      } else if (page === "appointments") {
        window.location.href = "doctor-appointments.html";
      } else if (page === "medicine") {
        window.location.href = "medicine.html";
      } else if (page === "patient-portal") {
        window.location.href = "patient-auth.html";
      }
    }

    async function loadProfile() {
      const email = localStorage.getItem("email");
      const token = localStorage.getItem("token");

      if (!email && !token) {
        alert("Not logged in ");
        window.location.href = "signup.html?mode=login";
        return;
      }

      let profileData = null;

      // 1. Try from localStorage (your old flow)
      profileData = JSON.parse(localStorage.getItem("doctorProfile"));
      if (!profileData && email) {
        const profiles = JSON.parse(localStorage.getItem("doctorProfiles")) || {};
        profileData = profiles[email];
      }

      // 2. ALWAYS try from backend to ensure data is fresh (Registration No fixes)
      if (token) {
        // Try plural endpoint first, then singular ‚Äî supports either backend mounting.
        const endpoints = [
          `${window.API_BASE_URL}/api/doctor/profile`,
          `${window.API_BASE_URL}/api/doctor/me`
        ];

        for (let ep of endpoints) {
          try {
            const res = await fetch(ep, {
              headers: { "Authorization": "Bearer " + token }
            });

            if (!res.ok) continue;

            const json = await res.json();
            let fetchedProfile = json && json.doctor ? json.doctor : json;

            // Cache it
            if (fetchedProfile && typeof fetchedProfile === "object" && (fetchedProfile.fullName || fetchedProfile.name)) {
              profileData = fetchedProfile;
              localStorage.setItem("doctorProfile", JSON.stringify(profileData));
              break;
            }
          } catch (err) {
            console.warn("Error fetching profile from", ep, err);
          }
        }
      }

      // 2b. If still not found but we have an email, try email-based endpoint
      if (!profileData && email) {
        try {
          const res = await fetch(`${API_BASE_URL}/api/doctors/profile/` + encodeURIComponent(email));
          if (res.ok) {
            const json = await res.json().catch(() => null);
            if (json && (json.doctor || json.data?.doctor)) {
              profileData = json.doctor || json.data?.doctor;
              localStorage.setItem("doctorProfile", JSON.stringify(profileData));
            }
          }
        } catch (err) {
          console.warn("Email-based profile fetch failed", err);
        }
      }

      // 3. Normalize profileData if it still has a nested doctor property (from old saves)
      if (profileData && profileData.doctor) {
        profileData = profileData.doctor;
      }

      // 4. Validate profile
      if (!profileData || (!profileData.fullName && !profileData.name)) {
        alert("Please complete your profile details first.");
        window.location.href = "profile-setup.html";
        return;
      }

      // Update welcome message with doctor's name
      const displayName = profileData.fullName || profileData.name || "Doctor";
      document.getElementById("doctor-name").innerText = displayName;

      // Cache the name for future use
      localStorage.setItem("doctorName", displayName);
    }

    function logout() {
      try { localStorage.setItem("global_logout", String(Date.now())); } catch (e) { }
      localStorage.removeItem("email");
      localStorage.removeItem("token");
      localStorage.removeItem("loggedIn");
      localStorage.removeItem("doctorName");
      localStorage.removeItem("doctorProfile");
      alert("You have logged out ");
      window.location.href = "maindashboard.html";
    }

    // Load profile on page load
    loadProfile();

    // Replace login button with profile + logout if logged in
    const authDiv = document.getElementById("auth-buttons");

    // Prefer doctorProfile.fullName, then doctorName, then fallback to generic
    let displayName = null;
    try {
      const profileRaw = localStorage.getItem("doctorProfile");
      if (profileRaw) {
        const prof = JSON.parse(profileRaw);
        displayName = prof && (prof.fullName || prof.name) ? (prof.fullName || prof.name) : null;
      }
    } catch (e) {
      // ignore parse errors
    }
    // fallback to doctorName stored previously or generic
    if (!displayName) displayName = localStorage.getItem("doctorName") || null;
    const email = localStorage.getItem("email");

    if (authDiv) {
      if (displayName || email) {
        // Logged in
        authDiv.innerHTML = `
          <button class="book-btn" onclick="navigateTo('profile')">Profile</button>
          <button class="book-btn" style="background:#ff4d4d; color:white;" onclick="logout()">Logout</button>
        `;
        // Update welcome message with cached name if available
        if (displayName) {
          document.getElementById("doctor-name").innerText = displayName;
        }
      } else {
        // Not logged in
        authDiv.innerHTML = `
          <button class="book-btn" onclick="navigateTo('signup')">Login</button>
        `;
      }
    }
  </script>
  <script>
    // Cross-tab logout listener
    window.addEventListener("storage", function (e) {
      if (e && e.key === "global_logout") {
        const hasAuth = localStorage.getItem("email") || localStorage.getItem("token");
        if (hasAuth) {
          localStorage.removeItem("email");
          localStorage.removeItem("token");
          localStorage.removeItem("loggedIn");
          localStorage.removeItem("doctorName");
          localStorage.removeItem("doctorProfile");
          window.location.href = "maindashboard.html";
        }
      }
    });
  </script>
  <script src="js/chatbot.js"></script>
  <script src="js/doctor-theme.js"></script>
</body>

</html>