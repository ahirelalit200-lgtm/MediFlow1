<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prescription History</title>
  <!-- keep existing stylesheet untouched -->
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/chatbot.css" />
  <script src="js/config.js"></script>

</head>

<body>
  <header class="navbar">
    <div class="logo">
      <img src="assets/care.png" alt="Logo" height="40" />
      <span>Medi<strong>Flow</strong></span>
    </div>
    <nav>
      <ul>
        <li onclick="navigateTo('dashboard')">Home</li>
        <li onclick="navigateTo('prescription')">Prescription</li>
        <li onclick="navigateTo('appointments')">Appointments</li>
        <li onclick="navigateTo('analytics')">Analytics</li>
        <li onclick="navigateTo('xray')">X-Ray</li>
        <li onclick="navigateTo('medicine')">Add Medicine</li>
      </ul>
    </nav>
    <div class="header-right" id="auth-buttons">
      <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Dark Mode">
        <span class="theme-icon" id="theme-icon">üåô</span>
      </button>
    </div>
  </header>

  <main class="content-wrapper">
    <div class="form-container" style="max-width: 1100px;">
      <div class="profile-header"
        style="justify-content: space-between; border-bottom: none; margin-bottom: 1.5rem; padding-bottom: 0;">
        <div class="profile-info">
          <h1>Prescription History</h1>
          <p>Access and manage all previous patient records</p>
        </div>
        <div class="header-right">
          <button class="book-btn" id="toggleSearchBtn"
            style="background: var(--bg-tertiary); color: var(--text-primary);">Search Filters</button>
          <button class="book-btn" id="toggleDeleteBtn"
            style="background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger);">Manage
            Records</button>
        </div>
      </div>

      <!-- Search panel -->
      <section id="searchPanel"
        style="display: none; background: var(--bg-tertiary); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 2rem;">
        <div class="profile-grid">
          <div class="form-group">
            <label>Patient Name</label>
            <input type="text" id="searchName" placeholder="Search by name..." />
          </div>
          <div class="form-group">
            <label>Mobile Number</label>
            <input type="text" id="searchMobile" placeholder="Search by number..." />
          </div>
        </div>
        <div class="header-right" style="justify-content: flex-end; margin-top: 1rem;">
          <button class="book-btn" id="searchBtn">Apply Filters</button>
          <button class="book-btn" id="resetBtn"
            style="background: transparent; color: var(--text-secondary);">Reset</button>
        </div>
      </section>

      <!-- Delete panel -->
      <section id="deletePanel"
        style="display:none; background: rgba(239, 68, 68, 0.05); border: 1px dashed var(--danger); padding: 1.5rem; border-radius: var(--radius-md); margin-bottom: 2rem;">
        <div style="display:flex; justify-content: space-between; align-items:center;">
          <div class="profile-info">
            <h3 style="color: var(--danger); margin: 0;">Manage Records</h3>
            <p style="font-size: 0.875rem;">Select entries to permanently remove from local history.</p>
          </div>
          <div class="header-right">
            <button class="book-btn" id="deleteAllBtn" style="background: var(--danger);">Delete All</button>
            <button class="book-btn" id="deleteSelectedBtn" style="background: var(--danger); opacity: 0.8;">Delete
              Selected</button>
          </div>
        </div>
      </section>

      <!-- Cards container -->
      <section id="cards" class="cards" style="display: flex; flex-direction: column; gap: 1rem;">
        <div class="empty-state"
          style="text-align: center; padding: 4rem; color: var(--text-muted); border: 2px dashed var(--border-color); border-radius: var(--radius-lg);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
          <p>No prescription records found.</p>
        </div>
      </section>
    </div>
  </main>

  <!-- Details Modal -->
  <div id="detailBackdrop" class="modal-backdrop"
    style="display:none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.75); backdrop-filter: blur(4px); z-index: 2000; align-items: center; justify-content: center;">
    <div class="form-container" style="max-width: 900px; max-height: 90vh; overflow-y: auto; margin: 0;">
      <div class="profile-header" style="justify-content: space-between; margin-bottom: 2rem;">
        <div class="profile-info">
          <h1>Record Details</h1>
        </div>
        <div class="header-right">
          <button class="book-btn" id="detailPrint" style="background: var(--success);">Print RX</button>
          <button class="book-btn" id="detailClose"
            style="background: var(--bg-tertiary); color: var(--text-primary);">Close</button>
        </div>
      </div>
      <div id="detailBody"></div>
    </div>
  </div>

  <!-- keep the same utility + logic scripts so functionality remains unchanged -->
  <script src="js/history-utils.js"></script>
  <script>
    // Theme management functions - Force light theme
    function initializeTheme() {
      // Force light theme for consistency
      const theme = 'light';
      setTheme(theme);
      updateThemeIcon(theme);
    }

    function setTheme(theme) {
      // Always remove dark theme attribute
      document.body.removeAttribute('data-theme');
      localStorage.setItem('theme', 'light');
    }

    function toggleTheme() {
      // Keep theme always light - disable toggle
      setTheme('light');
      updateThemeIcon('light');
    }

    function updateThemeIcon(theme) {
      const icon = document.getElementById('theme-icon');
      if (icon) {
        icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      }
    }

    // Initialize theme on page load
    initializeTheme();

    /* === Original JS kept as-is to ensure identical functionality === */
    let __currentRecordForPrint = null; // holds normalized record for printing
    let __deleteMode = false; // whether selection checkboxes are visible
    let __lastNormalizedList = []; // cache of last normalized records rendered

    function navigateTo(page) {
      if (page === "signup") { window.location.href = "signup.html"; }
      else if (page === "profile") { window.location.href = "profile.html"; }
      else if (page === "prescription") { window.location.href = "prescription.html"; }
      else if (page === "dashboard") { window.location.href = "doctor-dashboard.html"; }
      else if (page === "history") { window.location.href = "history.html"; }
      else if (page === "xray") { window.location.href = "xray.html"; }
      else if (page === "medicine") { window.location.href = "medicine.html"; }
      else if (page === "appointments") { window.location.href = "doctor-appointments.html"; }
      else if (page === "analytics") { window.location.href = "analytics.html"; }
    }

    function renderAuthButtons() {
      const authDiv = document.getElementById("auth-buttons");
      if (!authDiv) return;
      const displayName = (JSON.parse(localStorage.getItem("doctorProfile") || "null")?.fullName) || localStorage.getItem("doctorName");
      const email = localStorage.getItem("email");
      if (displayName || email) {
        authDiv.innerHTML = ``;
      } else {
        authDiv.innerHTML = `<button class="book-btn" onclick="navigateTo('signup')">Login</button>`;
      }
    }

    function logout() {
      try { localStorage.setItem("global_logout", String(Date.now())); } catch (e) { }
      localStorage.removeItem("email");
      localStorage.removeItem("token");
      localStorage.removeItem("loggedIn");
      localStorage.removeItem("doctorName");
      localStorage.removeItem("doctorProfile");
      renderAuthButtons();
      alert("You have logged out ");
      window.location.href = "index.html";
    }

    renderAuthButtons();

    window.addEventListener("storage", function (e) {
      if (e && e.key === "global_logout") {
        const hasAuth = localStorage.getItem("email") || localStorage.getItem("token");
        if (hasAuth) {
          localStorage.removeItem("email");
          localStorage.removeItem("token");
          localStorage.removeItem("loggedIn");
          localStorage.removeItem("doctorName");
          localStorage.removeItem("doctorProfile");
        }
        renderAuthButtons();
        window.location.href = "index.html";
      }
    });

    // ------------------ helpers ------------------
    function escapeHtml(str) {
      if (str === null || str === undefined) return "";
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function normalizeItem(p) {
      const medArr = p.medicines || p.prescription?.medicines || p.meds || [];
      const patientName = p.patientName || p.patient || p.prescription?.patientName || "‚Äî";
      const mobile = p.mobile || p.mobileNumber || p.prescription?.mobile || "-";
      const doctor = p.doctor || p.prescription?.doctor || p.doctorName || "-";
      const dateVal = p.date || p.createdAt || p.timestamp || p.prescription?.date || "";
      const notes = p.notes || p.prescription?.notes || "";
      const xray = p.xray || p.prescription?.xray || null; // include x-ray if present
      const id = p.id || p._id || p.prescription?.id || null; // local entries have id

      let date = null;
      try {
        if (p.timestamp && !isNaN(Number(p.timestamp))) date = new Date(Number(p.timestamp));
        else if (p.createdAt) date = new Date(p.createdAt);
        else if (dateVal) date = new Date(dateVal);
        else if (p._id) {
          // Try to extract date from MongoDB ObjectId (timestamp is embedded in first 4 bytes)
          const timestamp = parseInt(p._id.toString().substring(0, 8), 16);
          if (!isNaN(timestamp)) date = new Date(timestamp * 1000);
        }
        // If still no date, use current date
        if (!date || isNaN(date.getTime())) date = new Date();
      } catch (_e) {
        date = new Date(); // Fallback to current date
      }

      const meds = Array.isArray(medArr) ? medArr.map(m => {
        if (m && typeof m === 'object') return { name: m.name || m.medicine || "", dosage: m.dosage || "", duration: m.duration || "", measure: m.measure || "", instruction: m.instruction || "" };
        return { name: String(m), dosage: "", duration: "", measure: "", instruction: "" };
      }) : [];

      return { id, patientName, mobile, doctor, notes, medicines: meds, date, xray, raw: p };
    }

    function groupByPatient(items) {
      const groups = new Map();
      items.forEach(it => {
        const nameKey = (it.patientName || "").trim().toLowerCase() || "‚Äî";
        const mobileKey = (it.mobile || "").trim().toLowerCase() || "-";
        const key = nameKey + "||" + mobileKey;
        if (!groups.has(key)) {
          groups.set(key, { patientName: it.patientName || "‚Äî", mobile: it.mobile || "-", records: [] });
        }
        groups.get(key).records.push(it);
      });
      for (const g of groups.values()) {
        g.records.sort((a, b) => (b.date?.getTime() || 0) - (a.date?.getTime() || 0));
        g.lastDate = g.records[0]?.date || null;
      }
      return Array.from(groups.values()).sort((a, b) => (b.lastDate?.getTime() || 0) - (a.lastDate?.getTime() || 0));
    }

    function formatDate(d) {
      if (!d || isNaN(d)) return "-";
      try { return d.toLocaleString(); } catch { return "-"; }
    }

    function renderCards(list) {
      const cards = document.getElementById("cards");
      if (!cards) return;
      cards.innerHTML = "";
      __lastNormalizedList = Array.isArray(list) ? list : [];
      if (!Array.isArray(list) || list.length === 0) {
        cards.innerHTML = `
          <div class="empty-state" style="text-align: center; padding: 4rem; color: var(--text-muted); border: 2px dashed var(--border-color); border-radius: var(--radius-lg);">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìÇ</div>
            <p>No prescription records found.</p>
          </div>`;
        return;
      }

      const grouped = groupByPatient(list);

      grouped.forEach((group, index) => {
        const count = group.records.length;
        const last = group.lastDate ? formatDate(group.lastDate) : "-";

        const card = document.createElement("div");
        card.className = "feature-card";
        card.style.cursor = "default";
        card.innerHTML = `
          <div class="patient-header" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
            <div>
              <div style="font-size: 1.125rem; font-weight: 700; color: var(--text-primary);">${escapeHtml(group.patientName)}</div>
              <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                Mobile: ${escapeHtml(group.mobile)}
                <span class="badge" style="background: var(--bg-tertiary); color: var(--accent-primary); padding: 0.125rem 0.5rem; border-radius: 999px; margin-left: 0.5rem; font-size: 0.75rem;">${count} Record${count > 1 ? 's' : ''}</span>
                <span class="badge" style="background: var(--bg-tertiary); color: var(--text-muted); padding: 0.125rem 0.5rem; border-radius: 999px; margin-left: 0.5rem; font-size: 0.75rem;">Last: ${escapeHtml(last)}</span>
              </div>
            </div>
            <div style="display:flex; align-items:center; gap:1.5rem;">
              ${__deleteMode ? '<label style="display:flex; align-items:center; gap:0.5rem; cursor:pointer;"><input type="checkbox" class="patient-select-all" /> <span style="font-size: 0.875rem; font-weight: 600;">Select All</span></label>' : ''}
              <div class="expand-icon" style="transition: transform 0.2s;">‚ñ∂</div>
            </div>
          </div>
          <div class="patient-details" style="display: none; margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <table class="professional-table" style="margin-bottom: 0; box-shadow: none; border-radius: 0; border: none;">
              <thead>
                <tr>
                  ${__deleteMode ? '<th style="width: 40px;"><input type="checkbox" class="group-select-all"/></th>' : ''}
                  <th style="width: 40px;">#</th>
                  <th>Medicines</th>
                  <th>Consulting Doctor</th>
                  <th>Clinical Date</th>
                </tr>
              </thead>
              <tbody>
                ${group.records.map((r, idx) => `
                  <tr data-idx="${idx}" ${r.id ? `data-id="${String(r.id)}"` : ''} style="cursor:pointer;">
                    ${__deleteMode ? `<td><input type="checkbox" class="rec-select" ${r.id ? '' : 'disabled'} /></td>` : ''}
                    <td>${idx + 1}</td>
                    <td>${escapeHtml((r.medicines || []).map(m => m.name || m).join(", ") || "-")}</td>
                    <td>Dr. ${escapeHtml(r.doctor || "-")}</td>
                    <td>${escapeHtml(formatDate(r.date))}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;

        const header = card.querySelector(".patient-header");
        header.addEventListener("click", () => {
          const details = card.querySelector(".patient-details");
          const icon = card.querySelector(".expand-icon");
          const isHidden = details.style.display === "none";
          details.style.display = isHidden ? "block" : "none";
          icon.style.transform = isHidden ? "rotate(90deg)" : "rotate(0deg)";
        });
        header.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") { e.preventDefault(); header.click(); }
        });

        console.log("üîπ Appending card to DOM for patient:", group.patientName);
        document.getElementById("cards").appendChild(card);
        console.log("üîπ Card appended successfully");

        const rows = card.querySelectorAll("tbody tr[data-idx]");
        rows.forEach(row => {
          row.addEventListener("click", (e) => {
            const tgt = e && e.target;
            if (__deleteMode && tgt && tgt instanceof Element && tgt.closest('input[type="checkbox"]')) return;
            const i = Number(row.getAttribute("data-idx"));
            const record = group.records[i];
            if (record) showDetails(record);
          });
        });

        if (__deleteMode) {
          const patientSelect = card.querySelector('.patient-select-all');
          if (patientSelect) {
            patientSelect.addEventListener('change', (e) => {
              const target = e && e.target;
              const checked = target && typeof target.checked === 'boolean' ? target.checked : false;
              card.querySelectorAll('input.rec-select:not(:disabled)').forEach((cb) => { if (cb instanceof HTMLInputElement) cb.checked = checked; });
              const groupSelect = card.querySelector('.group-select-all');
              if (groupSelect && groupSelect instanceof HTMLInputElement) groupSelect.checked = checked;
              syncSelectAllMaster();
            });
          }
        }

        if (__deleteMode) {
          const groupSelect = card.querySelector('.group-select-all');
          if (groupSelect) {
            groupSelect.addEventListener('change', (e) => {
              const target = e && e.target;
              const checked = target && typeof target.checked === 'boolean' ? target.checked : false;
              card.querySelectorAll('input.rec-select:not(:disabled)').forEach((cb) => { if (cb instanceof HTMLInputElement) cb.checked = checked; });
              const patientSelect = card.querySelector('.patient-select-all');
              if (patientSelect && patientSelect instanceof HTMLInputElement) patientSelect.checked = checked;
              syncSelectAllMaster();
            });
          }
        }
      });

      console.log("üîπ Finished rendering. Cards container now has:", document.getElementById("cards").children.length, "children");
      console.log("üîπ Cards container HTML:", document.getElementById("cards").innerHTML.substring(0, 200) + "...");
      console.log("üîπ Cards container styles:", window.getComputedStyle(document.getElementById("cards")).display);
      console.log("üîπ Cards container visible:", document.getElementById("cards").offsetHeight > 0);

      // Check individual card styles
      const firstCard = document.querySelector(".patient-card");
      if (firstCard) {
        console.log("üîπ First card styles:", window.getComputedStyle(firstCard).display);
        console.log("üîπ First card visible:", firstCard.offsetHeight > 0);
        console.log("üîπ First card position:", window.getComputedStyle(firstCard).position);
        console.log("üîπ First card z-index:", window.getComputedStyle(firstCard).zIndex);
        console.log("üîπ First card opacity:", window.getComputedStyle(firstCard).opacity);

        // Remove test styles - cards are working!
        console.log("üîπ Cards are working properly - removing test styles");
      }
    }

    function buildPrintableHTML(rec) {
      const clinicName = (JSON.parse(localStorage.getItem("doctorProfile") || "null")?.clinicName) || "MediFlow Clinic";
      const doctorName = rec.doctor || (JSON.parse(localStorage.getItem("doctorProfile") || "null")?.fullName) || "-";
      const regNo = (JSON.parse(localStorage.getItem("doctorProfile") || "null")?.registrationNumber) || "";
      const address = (JSON.parse(localStorage.getItem("doctorProfile") || "null")?.address) || "";
      const phone = (JSON.parse(localStorage.getItem("doctorProfile") || "null")?.phone) || "";

      const medsRows = (rec.medicines || []).map(m => `
        <tr>
          <td>${escapeHtml(m.name || "-")}</td>
          <td>${escapeHtml(m.dosage || "-")}</td>
          <td>${escapeHtml(m.duration || "-")}</td>
          <td>${escapeHtml(m.measure || "-")}</td>
          <td>${escapeHtml(m.instruction || "-")}</td>
        </tr>
      `).join("");

      return `
        <div id="printable">
          <div class="rx-header">
            <div>
              <div class="rx-clinic">${escapeHtml(clinicName)}</div>
              <div class="rx-meta">Dr. ${escapeHtml(doctorName)} ${regNo ? "‚Ä¢ Reg: " + escapeHtml(regNo) : ""}</div>
              <div class="rx-meta">${escapeHtml(address)} ${phone ? "‚Ä¢ " + escapeHtml(phone) : ""}</div>
            </div>
            <div style="font-size:24px; font-weight:800;">‚Ñû</div>
          </div>

          <div style="display:flex; gap:20px; flex-wrap:wrap; margin-bottom:8px;">
            <div><strong>Patient:</strong> ${escapeHtml(rec.patientName || "‚Äî")}</div>
            <div><strong>Mobile:</strong> ${escapeHtml(rec.mobile || "-")}</div>
            <div><strong>Date:</strong> ${escapeHtml(rec.date ? formatDate(rec.date) : "-")}</div>
          </div>

          ${rec.notes ? `<div class="rx-section-title">Notes</div><div>${escapeHtml(rec.notes)}</div>` : ""}

          ${rec.xray && rec.xray.dataUrl ? `
          <section class="rx-xray">
            <div class="rx-section-title">X-ray</div>
            <div style="margin: 8px 0 12px;">
              <img class="rx-xray-img" src="${rec.xray.dataUrl}" alt="X-ray" style="border:1px solid #000; border-radius:6px;"/>
            </div>
          </section>
          ` : ''}

          <div class="rx-section-title">Medicines</div>
          <table class="rx-table">
            <thead>
              <tr>
                <th>Medicine</th>
                <th>Dosage</th>
                <th>Duration</th>
                <th>Measure</th>
                <th>Instruction</th>
              </tr>
            </thead>
            <tbody>
              ${medsRows || `<tr><td colspan="5" style="text-align:center;">No medicines</td></tr>`}
            </tbody>
          </table>

          <div style="display:flex; justify-content:space-between; margin-top:24px;">
            <div><em>This is a digitally generated prescription.</em></div>
            <div style="text-align:right;">
              <div style="height:50px;"></div>
              <strong>Signature</strong>
            </div>
          </div>
        </div>
      `;
    }

    function showDetails(record) {
      const raw = record && record.raw ? record.raw : record;
      const body = document.getElementById("detailBody");
      __currentRecordForPrint = record; // save for Print button

      const patientName = record.patientName || raw.patient || raw.patientName || "‚Äî";
      const mobile = record.mobile || raw.mobileNumber || raw.mobile || "-";
      const doctor = record.doctor || raw.doctor || raw.doctorName || "-";
      const dateStr = record.date ? formatDate(record.date) : (raw.date ? formatDate(new Date(raw.date)) : "-");
      const notes = record.notes || raw.notes || (raw.prescription && raw.prescription.notes) || "";
      const xray = record.xray || raw.xray || (raw.prescription && raw.prescription.xray) || null;

      const meds = (Array.isArray(record.medicines) && record.medicines.length)
        ? record.medicines
        : ((raw.prescription && Array.isArray(raw.prescription.medicines)) ? raw.prescription.medicines : (raw.medicines || []))
          .map(m => ({ name: m.name || m.medicine || "-", dosage: m.dosage || "-", duration: m.duration || "-", measure: m.measure || "-", instruction: m.instruction || "-" }));

      const medsRows = meds.map(m => `
        <tr>
          <td>${escapeHtml(m.name || "-")}</td>
          <td>${escapeHtml(m.dosage || "-")}</td>
          <td>${escapeHtml(m.duration || "-")}</td>
          <td>${escapeHtml(m.measure || "-")}</td>
          <td>${escapeHtml(m.instruction || "-")}</td>
        </tr>
      `).join("");

      body.innerHTML = `
        <div style="display:flex; gap:24px; flex-wrap:wrap;">
          <div style="flex:1 1 260px;">
            <p><strong>Patient:</strong> ${escapeHtml(patientName)}</p>
            <p><strong>Mobile:</strong> ${escapeHtml(mobile)}</p>
            <p><strong>Doctor:</strong> ${escapeHtml(doctor)}</p>
            <p><strong>Date:</strong> ${escapeHtml(dateStr)}</p>
            ${notes ? `<p><strong>Notes:</strong> ${escapeHtml(notes)}</p>` : ""}
          </div>
          ${xray && xray.dataUrl ? `<div style="flex:1 1 260px;">
            <p><strong>X-ray:</strong> ${escapeHtml(xray.name || '')}</p>
            <img src="${xray.dataUrl}" alt="X-ray image" style="max-width:280px; border-radius:6px; border:1px solid #ddd;"/>
          </div>` : ''}
        </div>

        <h4 style="margin:10px 0;">Medicines</h4>
        <table style="width:100%; border-collapse:collapse;" border="1" cellspacing="0" cellpadding="6">
          <thead>
            <tr style="background:#f7f7f7;">
              <th>Medicine</th>
              <th>Dosage</th>
              <th>Duration</th>
              <th>Measure</th>
              <th>Instruction</th>
            </tr>
          </thead>
          <tbody>
            ${medsRows || `<tr><td colspan="5" style="text-align:center;">No medicines</td></tr>`}
          </tbody>
        </table>

        ${buildPrintableHTML({ ...record, notes, medicines: meds })}
      `;

      const backdrop = document.getElementById("detailBackdrop");
      backdrop.style.display = "flex";
      backdrop.setAttribute("aria-hidden", "false");
    }

    // ------------------ fetchHistory: tries server then local fallback ------------------
    async function fetchHistory() {
      const nameFilter = (document.getElementById("searchName")?.value || "").toLowerCase().trim();
      const mobileFilter = (document.getElementById("searchMobile")?.value || "").toLowerCase().trim();

      const token = localStorage.getItem("token");
      if (token) {
        try {
          const params = new URLSearchParams();
          if (nameFilter) params.append("name", nameFilter);
          if (mobileFilter) params.append("mobile", mobileFilter);
          const url = `${window.API_BASE_URL}/api/prescriptions/history` + (params.toString() ? `?${params.toString()}` : "");
          console.log("üîπ Fetching history from:", url);
          const res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
          console.log("üîπ History API response status:", res.status);
          if (res.ok) {
            const json = await res.json().catch(() => null);
            console.log("üîπ Raw API response:", json);
            if (json.items && json.items.length > 0) {
              console.log("üîπ Sample item date fields:", {
                date: json.items[0].date,
                createdAt: json.items[0].createdAt,
                timestamp: json.items[0].timestamp
              });
            }
            let items = [];
            if (json && Array.isArray(json)) items = json;
            else if (json && Array.isArray(json.items)) items = json.items;
            else if (json && Array.isArray(json.data)) items = json.data;
            else if (json && Array.isArray(json.history)) items = json.history;
            else if (json && Array.isArray(json.results)) items = json.results;

            console.log("üîπ Extracted items:", items);
            console.log("üîπ Items count:", items.length);

            const normalized = items.map(normalizeItem).filter(it => {
              const pName = (it.patientName || "").toLowerCase();
              const pMobile = (it.mobile || "").toLowerCase();
              if (nameFilter && !pName.includes(nameFilter)) return false;
              if (mobileFilter && !pMobile.includes(mobileFilter)) return false;
              return true;
            });
            console.log("üîπ Normalized items:", normalized);
            console.log("üîπ Normalized count:", normalized.length);
            if (normalized.length > 0) {
              console.log("üîπ Sample normalized item date:", {
                rawDate: normalized[0].raw?.date,
                rawCreatedAt: normalized[0].raw?.createdAt,
                parsedDate: normalized[0].date
              });
            }
            console.log("üîπ Calling renderCards with:", normalized);
            renderCards(normalized);
            return;
          } else {
            console.warn("Server history fetch returned", res.status, "falling back to localStorage");
            try {
              const errorText = await res.text();
              console.warn("Error response body:", errorText);
            } catch (e) {
              console.warn("Could not read error response:", e);
            }
          }
        } catch (err) {
          console.warn("Server history fetch failed, falling back to localStorage:", err);
        }
      }

      if (window.historyUtils && typeof window.historyUtils.getHistoryForCurrentUser === "function") {
        try {
          const all = window.historyUtils.getHistoryForCurrentUser() || [];
          const normalized = all.map(normalizeItem).filter(it => {
            const pName = (it.patientName || "").toLowerCase();
            const pMobile = (it.mobile || "").toLowerCase();
            if (nameFilter && !pName.includes(nameFilter)) return false;
            if (mobileFilter && !pMobile.includes(mobileFilter)) return false;
            return true;
          });
          renderCards(normalized);
          return;
        } catch (err) {
          console.warn("Local history read failed:", err);
        }
      }

      renderCards([]);
    }

    function resetSearch() {
      document.getElementById("searchName").value = "";
      document.getElementById("searchMobile").value = "";
      fetchHistory();
    }

    // ------------------ UI bindings ------------------
    const toggleBtn = document.getElementById("toggleSearchBtn");
    const searchPanel = document.getElementById("searchPanel");
    toggleBtn.addEventListener("click", () => {
      const currentlyOpen = searchPanel.style.display === "block";
      searchPanel.style.display = currentlyOpen ? "none" : "block";
      toggleBtn.setAttribute("aria-expanded", String(!currentlyOpen));
      searchPanel.setAttribute("aria-hidden", String(currentlyOpen));
    });

    document.getElementById("searchBtn").addEventListener("click", (e) => { e.preventDefault(); fetchHistory(); });
    document.getElementById("resetBtn").addEventListener("click", (e) => { e.preventDefault(); resetSearch(); });

    // Initial load
    window.onload = fetchHistory;

    // Modal close
    document.getElementById("detailClose").addEventListener("click", () => {
      const backdrop = document.getElementById("detailBackdrop");
      backdrop.style.display = "none";
      backdrop.setAttribute("aria-hidden", "true");
      __currentRecordForPrint = null;
    });

    document.getElementById("detailBackdrop").addEventListener("click", (e) => {
      if (e.target && e.target.id === "detailBackdrop") {
        document.getElementById("detailClose").click();
      }
    });

    // Print handler
    document.getElementById("detailPrint").addEventListener("click", () => {
      if (!__currentRecordForPrint) return;
      const body = document.getElementById("detailBody");
      const existing = body.querySelector("#printable");
      if (existing) existing.remove();
      body.insertAdjacentHTML("beforeend", buildPrintableHTML(__currentRecordForPrint));
      window.print();
    });

    // ------------------ Delete mode bindings ------------------
    const deletePanel = document.getElementById('deletePanel');
    const toggleDeleteBtn = document.getElementById('toggleDeleteBtn');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');

    function setDeleteMode(on) {
      __deleteMode = !!on;
      deletePanel.style.display = __deleteMode ? 'block' : 'none';
      toggleDeleteBtn.setAttribute('aria-expanded', String(__deleteMode));
      renderCards(__lastNormalizedList);
      if (selectAllCheckbox) selectAllCheckbox.checked = false;
    }

    toggleDeleteBtn.addEventListener('click', () => { setDeleteMode(!__deleteMode); });

    function getLocalHistoryKey() {
      try {
        if (!window.historyUtils) return null;
        const email = window.historyUtils.currentUserEmail();
        if (!email) return null;
        return window.historyUtils.emailKey(email);
      } catch { return null; }
    }

    function syncSelectAllMaster() {
      if (!__deleteMode) return;
      const all = Array.from(document.querySelectorAll('input.rec-select:not(:disabled)')).filter(el => el instanceof HTMLInputElement);
      if (!all.length) { if (selectAllCheckbox) selectAllCheckbox.checked = false; return; }
      const allChecked = all.every(cb => cb.checked);
      if (selectAllCheckbox) selectAllCheckbox.checked = allChecked;
    }

    if (selectAllCheckbox) {
      selectAllCheckbox.addEventListener('change', (e) => {
        const target = e && e.target;
        const checked = target && typeof target.checked === 'boolean' ? target.checked : false;
        document.querySelectorAll('input.rec-select:not(:disabled)').forEach((cb) => { if (cb instanceof HTMLInputElement) cb.checked = checked; });
      });

      console.log("üîπ Finished rendering. Cards container now has:", document.getElementById("cards").children.length, "children");
    }

    if (deleteAllBtn) {
      deleteAllBtn.addEventListener('click', () => {
        if (!confirm('Delete ALL history for this user? This cannot be undone.')) return;
        try {
          if (window.historyUtils && typeof window.historyUtils.clearHistoryForCurrentUser === 'function') {
            window.historyUtils.clearHistoryForCurrentUser();
          } else {
            const key = getLocalHistoryKey();
            if (key) localStorage.removeItem(key);
          }
        } catch { }
        fetchHistory();
      });
    }

    if (deleteSelectedBtn) {
      deleteSelectedBtn.addEventListener('click', () => {
        const selectedRows = Array.from(document.querySelectorAll('tbody tr[data-idx] input.rec-select:checked'))
          .map(cb => { const el = cb instanceof Element ? cb.closest('tr') : null; return el && el.matches('tr') ? el : null; })
          .filter(Boolean);
        if (!selectedRows.length) { alert('No records selected.'); return; }
        if (!confirm(`Delete ${selectedRows.length} selected record(s) from local history?`)) return;
        const ids = selectedRows.map(tr => tr.getAttribute('data-id')).filter(Boolean);
        if (!ids.length) { alert('Selected items are not deletable (no local id).'); return; }
        try {
          const key = getLocalHistoryKey();
          if (!key) return;
          const list = JSON.parse(localStorage.getItem(key) || '[]');
          if (!Array.isArray(list)) return;
          const filtered = list.filter(item => !ids.includes(String(item.id)));
          localStorage.setItem(key, JSON.stringify(filtered));
        } catch { }
        fetchHistory();
      });
    }
  </script>
  <script src="js/chatbot.js"></script>
</body>

</html>