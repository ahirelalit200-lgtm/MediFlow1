<!-- frontend/html-css/signup.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login / Signup</title>
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body>
  <main class="content-wrapper"
    style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 2rem; background: var(--bg-tertiary);">
    <div class="form-container"
      style="max-width: 450px; margin: 0; width: 100%; box-shadow: var(--shadow-lg); padding: 3rem;">
      <div class="logo" style="justify-content: center; margin-bottom: 2.5rem;"><img src="assets/care.png" alt="Logo"
          height="50" /><span style="font-size: 1.75rem;">Medi<strong>Flow</strong></span></div>
      <div class="profile-header"
        style="text-align: center; border-bottom: none; margin-bottom: 2rem; padding-bottom: 0;">
        <div class="profile-info" style="width: 100%;">
          <h1 id="auth-title">Practitioner Sign Up</h1>
          <p>Secure clinical access for medical professionals</p>
        </div>
      </div>
      <form id="auth-form">
        <div class="form-group" id="name-group"><label for="name">Full Professional Name</label><input type="text"
            id="name" placeholder="e.g. Dr. Jane Smith" /></div>
        <div class="form-group"><label for="email">Clinical Email Address</label><input type="email" id="email"
            placeholder="name@clinic.com" required /></div>
        <div class="form-group"><label for="password">Security Password</label><input type="password" id="password"
            placeholder="••••••••" required /></div>
        <div id="forgot-password-link"
          style="text-align: right; margin-top: -0.5rem; margin-bottom: 1.5rem; display: none;"><a href="#"
            onclick="handleForgotPassword(); return false;"
            style="color: var(--accent-primary); text-decoration: none; font-size: 0.9rem; font-weight: 500;">Forgot
            Password?</a></div>
        <div style="margin-top: 2rem;"><button type="submit" class="book-btn"
            style="width: 100%; padding: 1rem; font-size: 1.1rem; box-shadow: var(--shadow-sm);">Establish Clinical
            Access</button></div>
      </form>
      <div class="auth-toggle" onclick="toggleAuth()"
        style="margin-top: 2rem; text-align: center; color: var(--text-muted); font-size: 0.95rem; cursor: pointer; transition: color 0.2s;">
        Already registered? <span style="color: var(--accent-primary); font-weight: 600;">Sign In</span></div>
    </div>
  </main>
  <script>let isSignup = true;

    function toggleAuth(forceMode = null) {
      const title = document.getElementById("auth-title");
      const button = document.querySelector("#auth-form button");
      const toggleText = document.querySelector(".auth-toggle");
      const nameGroup = document.getElementById("name-group");
      const forgotPasswordLink = document.getElementById("forgot-password-link");

      if (forceMode === "login" || (!forceMode && isSignup)) {
        isSignup = false;
        title.innerText = "Login";
        button.innerText = "Login";
        toggleText.innerText = "Don't have an account? Sign Up";
        nameGroup.style.display = "none";
        if (forgotPasswordLink) forgotPasswordLink.style.display = "block";
      }

      else {
        isSignup = true;
        title.innerText = "Sign Up";
        button.innerText = "Sign Up";
        toggleText.innerText = "Already have an account? Login";
        nameGroup.style.display = "block";
        if (forgotPasswordLink) forgotPasswordLink.style.display = "none";
      }
    }

    async function handleForgotPassword() {
      const email = document.getElementById("email").value;

      if (!email) {
        alert("Please enter your email address first.");
        return;
      }

      try {
        const res = await fetch('http://localhost:5000/api/auth/forgot-password', {

          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }

          ,
          body: JSON.stringify({
            email
          })
        });

        const data = await res.json();

        if (res.ok) {
          alert("✅ " + data.message);
        }

        else {
          alert("❌ " + (data.message || "Failed to send reset email."));
        }
      }

      catch (err) {
        console.error("Forgot password error:", err);
        alert("❌ Server error. Please try again later.");
      }
    }

    // Auto-detect mode from URL
    window.addEventListener("DOMContentLoaded", () => {
      const params = new URLSearchParams(window.location.search);

      if (params.get("mode") === "login") {
        toggleAuth("login");
      }
    });

    document.getElementById("auth-form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = document.getElementById("name")?.value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      const url = isSignup ? `$ {
          window.API_BASE_URL
        }

        /api/signup` : `$ {
          window.API_BASE_URL
        }

        /api/login`;

      const payload = isSignup ? {
        name, email, password
      }

        : {
          email, password
        }

        ;

      try {
        const res = await fetch(url, {

          method: "POST",
          headers: {
            "Content-Type": "application/json"
          }

          ,
          body: JSON.stringify(payload),
        });

        const data = await res.json();

        if (!res.ok) {
          alert(data.message || "Something went wrong ");
          return;
        }

        if (isSignup) {
          // After signup → save token and go to profile setup
          alert("Signup successful! Please fill your profile next.");
          localStorage.setItem("email", email);

          // Save JWT token from backend
          if (data.token) {
            localStorage.setItem("token", data.token);
            localStorage.setItem("loggedIn", "true");
          }

          window.location.href = "profile-setup.html";
        }

        else {
          // Login success
          alert("Login successful!");
          localStorage.setItem("email", email);

          // Save JWT token from backend
          if (data.token) {
            localStorage.setItem("token", data.token);
            localStorage.setItem("loggedIn", "true");
          }

          // Save doctor profile returned from backend directly
          if (data.doctorProfile) {
            localStorage.setItem("doctorProfile", JSON.stringify(data.doctorProfile));
          }

          // Redirect to doctor dashboard
          window.location.href = "doctor-dashboard.html";
        }
      }

      catch (err) {
        console.error(err);
        alert("Server error ");
      }
    });
  </script>
</body>

</html>